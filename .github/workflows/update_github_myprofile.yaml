name: Update github myprofile

on:
  page_build:
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿ä½ éšæ—¶è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install Reqs
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3-setuptools

      # ğŸ” é¢„æ£€ï¼šç¡®è®¤ TOKEN å­˜åœ¨ + èƒ½è®¿é—®ç›®æ ‡ä»“åº“
      - name: Preflight auth check
        env:
          REMOTE_REPO: "https://SuperBearcafedo:${{ secrets.TOKEN }}@github.com/SuperBearcafedo/SuperBearcafedo.git"
        run: |
          # 1) æ£€æŸ¥ TOKEN æ˜¯å¦å­˜åœ¨
          if [ -z "${{ secrets.TOKEN }}" ]; then
            echo "::error::Missing secrets.TOKEN. Go to Settings â†’ Secrets and variables â†’ Actions, add TOKEN (a PAT with repo write)."
            exit 1
          fi
          # 2) å¿«é€Ÿæ¢æµ‹æƒé™ï¼ˆæ— è¾“å‡ºï¼Œå¤±è´¥æ‰æŠ¥é”™ï¼‰
          if ! git ls-remote "$REMOTE_REPO" >/dev/null 2>&1; then
            echo "::error::Cannot access target repo with provided TOKEN. Check: (a) PAT scope=repo (classic) æˆ– fine-grainedæˆäºˆè¯¥ä»“åº“çš„Contents:Read/Writeï¼›(b) è‹¥æ˜¯ç»„ç»‡ä»“åº“éœ€SSOæˆæƒï¼›(c) ä»“åº“æ˜¯å¦ç§æœ‰ä¸”PATå¯è§ã€‚"
            exit 1
          fi
          echo "Auth check passed."

      - name: Run
        env:
          REMOTE_REPO: "https://SuperBearcafedo:${{ secrets.TOKEN }}@github.com/SuperBearcafedo/SuperBearcafedo.git"
        run: |
          # è¿è¡Œæ›´æ–°è„šæœ¬
          cd ./github_myprofile_updater
          python3 update.py

          # å›åˆ°ä»“åº“æ ¹ç›®å½•åšæäº¤
          cd "${GITHUB_WORKSPACE}"

          git config --local user.name "SuperBearcafedo"
          git config --local user.email "sjiexiongmore@outlook.com"

          git add README.md
          git add images || true
          git commit -m "update my description automatically" || echo "nothing to commit"

          # æ¨é€åˆ°ç›®æ ‡ä»“åº“ main åˆ†æ”¯
          git push "${REMOTE_REPO}" HEAD:main --force
